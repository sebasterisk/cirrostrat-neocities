<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>your schedulizer</title>
    <link rel="stylesheet" href="/creations/schedulizer/style.css">
</head>
<body>
    <header>
        <h1>schedulizer!</h1>
    </header>
    <hr>
    <span id="errors"></span>

    <div id="tracker">
        <div id="clock">
            <span id="timenow"></span><br>
            <span id="date"></span>
        </div>

        <script>
            const timenow = document.getElementById("timenow")
            const date = document.getElementById("date")

            setInterval(function(){
                timenow.innerHTML = new Date().toLocaleTimeString()
                date.innerHTML = new Date().toLocaleDateString("en-US", {"dateStyle":"full"})
            })
        </script>
        
        <div id="status">
            <p id="allnext">
            </p>
        </div>
    </div>

    <div id="content">
        <div id="datatable_new">
            <p id="message">
                &darr; select a schedule type... &darr;
            </p>
        </div>

        <div id="calendar">
            <div class="calcontain" id="ficontain">
                <p class="small">
                    You can open a .ics calendar for viewing on 
                    schedulizer. This is currently an experimental 
                    feature. Uploading a new calendar will refresh the page.
                </p>
                <hr>
                <div class="fauxbutton">
                    <label for="calinput">Upload</label> <span class="small">max size 512kb</span>
                </div>
                <input type="file" name="calinput" id="calinput" accept=".ics,.ical,text/calendar">
            </div>
            <div id="calcontent">

            </div>

            <div class="caldivs" id="calbuttons">
                <button class="button" id="prevdate">&larr;</button>
                <button class="button" id="resettoday">today</button>
                <button class="button" id="nextdate">&rarr;</button>
                <button class="button" id="replace">replace calendar</button>
            </div>
        </div>
    </div>
    <script type="module">
        import ICAL from "https://unpkg.com/ical.js"
        
        const fiContain = document.getElementById("ficontain")
        const fileInput = document.getElementById("calinput")
        const savebtn = document.getElementById("calsave")
        const content = document.querySelector("#calcontent")
        const prev = document.getElementById("prevdate")
        const today = document.getElementById("resettoday")
        const next = document.getElementById("nextdate")
        const replace = document.getElementById("replace")
        const calbuttons = document.getElementById("calbuttons")

        let final
        let parsed
        let viewDate = new Date(new Date().setHours(0,0,0,0))

        function parse(icaldata){
            parsed = ICAL.parse(icaldata)
            //console.log(parsed)
            feventson(viewDate)
        }

        function feventson(now){
            if (!parsed){
                console.error("no jcal to parse")
                return
            }

            let parser = new ICAL.ComponentParser()
            let towrite = new Date(now).toLocaleDateString() + "<br><hr>"

            parser.onevent = (event) => {
                const s = event.startDate.toJSDate()
                const e = event.endDate.toJSDate()
                if ((now >= s) && (now < e)){
                    towrite += `${event.summary}<br><span class="small">`
                    if((e-s)<=(86400000)){
                        towrite += `${s.toLocaleDateString()}<br>`
                    } else {
                        towrite += `${s.toLocaleDateString()} - ${e.toLocaleDateString()}<br>`
                    }
                    towrite += "</span><hr>"
                }
            }

            parser.oncomplete = () => {
                content.innerHTML = towrite
                towrite = ""
            }
            parser.process(parsed)
        }

        if(window.localStorage.getItem("calendar")){
            final = window.localStorage.getItem("calendar")
            fiContain.style.visibility = "hidden"
            fiContain.hidden = true
            parse(final)
        } else {
            calbuttons.hidden = true
            content.hidden = true
        }

        function previewFile() {
            const [file] = calinput.files
            const reader = new FileReader()

            reader.addEventListener(
                "load",
                () => {
                    fiContain.style.visibility = "hidden"
                    fiContain.hidden = true
                    calbuttons.hidden = false
                    content.hidden = false
                    final = reader.result
                    window.localStorage.setItem("calendar", final)
                    parse(final)
                    location.reload()
                },
                false,
            );

            if (file && file.size <= 512000) {
                reader.readAsText(file);
            }
        }

        fileInput.onchange = previewFile

        replace.onclick = () => {
            fiContain.hidden = false
            fiContain.style.visibility = "visible"
            calbuttons.hidden = true
            content.hidden = true
        }

        prev.onclick = () => {
            viewDate = new Date(viewDate).getTime() - 86400000
            feventson(new Date(viewDate))
        }
        next.onclick = () => {
            viewDate = new Date(viewDate).getTime() + 86400000
            feventson(new Date(viewDate))
        }
        today.onclick = () => {
            viewDate = new Date().setHours(0,0,0,0)
            feventson(new Date(viewDate))
        }

    </script>

    <div id="options">
        schedule options:
        <select name="type" id="type">
            <option value="" selected disabled hidden>select schedule type</option>
            <option value="default">default</option>
            <option value="wed">wed</option>
            <option value="forum">forum</option>
            <option value="mass">mass</option>
            <!--
            <option value="earlydis">early dismissal</option>
            <option value="latestart">delayed start</option>
            <option value="anchor">anchor</option>
            -->
        </select>

        <select name="day" id="day" hidden>
        </select>
    </div>
    <button id="calendarbutton">open calendar</button>
    <script src="/creations/schedulizer/script.js">
    </script>

    <script>
        // for calendar sidebar open/close
        const cal = document.getElementById("calendar")
        const button = document.getElementById("calendarbutton")
        let open = false

        button.onclick = () => {
            if (!open) {
                open = true
                cal.style.width = "33%"

                cal.ontransitionend = () => {
                    if(open){
                        cal.style.visibility = "visible"
                        cal.style.textWrap = "wrap"
                    }
                }
            } else {
                open = false
                cal.style.width = "0"
                cal.style.visibility = "hidden"
                cal.style.textWrap = "nowrap"
            }

        }
    </script>

    <footer><hr>
        bookmark this link to save it! - part of the cirrostrat neocities website. <br> <a href="./index.html">edit schedule</a> - <a href="/index.html">go home</a>
    </footer>
</body>
</html>